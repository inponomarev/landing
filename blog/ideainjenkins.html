<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Ivan Ponomarev, PhD | Lecturer & tutor in Software Engineering with solid practical background</title>
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
    <link rel="stylesheet" href="../_/css/add.css"><script src="https://kit.fontawesome.com/7cc9d3cef1.js" crossorigin="anonymous"></script>
  </head>
  <body class="article">
<header class="header">
    <nav class="navbar">
        <div class="navbar-brand">
            <div class="navbar-item"><a href="/">Ivan Ponomarev, Ph.D.</a></div>
            <div class="navbar-item"></div>
            <a class="navbar-item" href="https://www.linkedin.com/in/inponomarev/">
                <i class="fa-brands fa-linkedin fa-fw"></i>
            </a>
            <a class="navbar-item" href="https://www.youtube.com/@inponomarev">
                <i class="fa-brands fa-youtube fa-fw"></i>
            </a>
            <a class="navbar-item" href="https://github.com/inponomarev">
                <i class="fa-brands fa-github fa-fw"></i>
            </a>
            <a class="navbar-item" href="https://twitter.com/inponomarev">
                <i class="fa-brands fa-twitter fa-fw"></i>
            </a>
            <div class="navbar-item"></div>
            <a class="navbar-item" href="/blog">
                <i class="fa-regular fa-pen-to-square"></i>
            </a>
        </div>
    </nav>
</header>

<div class="body">
<main class="article">
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Running IntelliJ IDEA in Jenkins</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>It may be argued that IntelliJ IDEA has the most advanced static Java code analyzer, whose capabilities leaves "veterans" like <a href="http://checkstyle.sourceforge.net/">Checkstyle</a> and <a href="https://spotbugs.github.io/">Spotbugs</a> far behind. Its many “inspections” check various aspects of the code, from coding style to certain kinds of bugs.</p>
</div>
<div class="paragraph">
<p>However, as long as the results of the analysis are visible only to a sole developer in her IDE, they are of little use in the software delivery process. Static analysis <a href="ratcheting.html" class="xref page">should be performed</a> as the first step of the delivery pipeline, and the build should fail if the results of this step don’t pass quality gates. JetBrains' TeamCity CI is known to be integrated with IDEA. Less known is the fact that even if you are not using TeamCity, you may run IDEA inspections on any other CI server. Let’s see how this may be done using the IDEA Community Edition, Jenkins, and the Warnings NG plugin.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_1_run_the_analysis_in_the_docker_container_and_produce_a_report"><a class="anchor" href="#_step_1_run_the_analysis_in_the_docker_container_and_produce_a_report"></a>Step 1: Run the Analysis in The Docker Container and Produce a Report</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Initially, the idea of running an IDE (a desktop application!) inside a CI system without a graphic interface may seem dubious and very challenging. Fortunately, IDEA developers have provided the option of running <a href="https://www.jetbrains.com/help/idea/command-line-formatter.html">code formatting</a> and the <a href="https://www.jetbrains.com/help/idea/command-line-code-inspector.html">code inspector</a> from the command line. Moreover, a graphics subsystem is not required to run IDEA in this mode, and these tasks can be performed on servers where only a text shell is available.</p>
</div>
<div class="paragraph">
<p>Inspections are run using the <code>bin/inspect.sh</code> script from the IDEA installation directory. The following parameters are required:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The complete path to the project (relative paths are not supported),</p>
</li>
<li>
<p>A path to the .xml file with inspection settings (usually located inside the project in <code>.idea/inspectionProfiles/Project_Default.xml</code>),</p>
</li>
<li>
<p>A complete path to the folder to which .xml files with analysis results reports will be added.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In addition, the following is expected:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The path to the Java SDK should be configured in the IDE; otherwise, the analysis will not work. These settings are contained in the <code>jdk.table.xml</code> configuration file in the IDEA global configuration folder. The global IDEA configuration itself is located in the user&#8217;s home directory by default, but this location can be specified in the <code>idea.properties</code> file.</p>
</li>
<li>
<p>The analyzed project must be a valid IDEA project, for which purpose certain files that are usually ignored will have to be committed to version control, i.e.:</p>
<div class="ulist">
<ul>
<li>
<p><code>.idea/inspectionProfiles/Project_Default.xml</code> — analyzer settings that will be explicitly used when launching inspections in the container;</p>
</li>
<li>
<p><code>.idea/modules.xml</code> — otherwise, we will get the "This project contains no modules" error message;</p>
</li>
<li>
<p><code>.idea/misc.xml</code> — otherwise, we will get the "The JDK is not configured properly for this project" error message;</p>
</li>
<li>
<p><code>.iml-files</code> — otherwise, we will get an error message regarding a non-configured JDK in the module.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Although these files are usually included in <code>.gitignore</code>, they do not contain any information specific to a particular developer’s environment — unlike, for example, the <code>workspace.xml</code> file, which does contain such information, thus there is no need to commit it.</p>
</div>
<div class="paragraph">
<p>Using Docker to pack the JDK together with IDEA Community Edition and its configuration files in a single container seems like a perfect way out. After we select the appropriate base image, here’s the Dockerfile we get:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-dockerfile hljs" data-lang="dockerfile">FROM openkbs/ubuntu-bionic-jdk-mvn-py3

ARG INTELLIJ_VERSION="ideaIC-2019.1.1"

ARG INTELLIJ_IDE_TAR=${INTELLIJ_VERSION}.tar.gz

ENV IDEA_PROJECT_DIR="/var/project"

WORKDIR /opt

COPY jdk.table.xml /etc/idea/config/options/

RUN wget https://download-cf.jetbrains.com/idea/${INTELLIJ_IDE_TAR} &amp;&amp; \
    tar xzf ${INTELLIJ_IDE_TAR} &amp;&amp; \
    tar tzf ${INTELLIJ_IDE_TAR} | head -1 | sed -e 's/\/.*//' | xargs -I{} ln -s {} idea &amp;&amp; \
    rm ${INTELLIJ_IDE_TAR} &amp;&amp; \
    echo idea.config.path=/etc/idea/config &gt;&gt; idea/bin/idea.properties &amp;&amp; \
    chmod -R 777 /etc/idea

CMD idea/bin/inspect.sh ${IDEA_PROJECT_DIR} ${IDEA_PROJECT_DIR}/.idea/inspectionProfiles/Project_Default.xml ${IDEA_PROJECT_DIR}/target/idea_inspections -v2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the <code>idea.config.path</code> option, we have forced IDEA to search for its global configuration in the <code>/etc/idea</code> folder, because when we work on CI server or in Docker, the user&#8217;s home directory is a thing that is ambiguous and often even completely missing.</p>
</div>
<div class="paragraph">
<p>This is what the <code>jdk.table.xml</code> file looks like when being copied to the container, with specified paths to the OpenJDK installed inside the container (it may be based on a similar file from your own directory with IDEA settings):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;application&gt;
 &lt;component name="ProjectJdkTable"&gt;
   &lt;jdk version="2"&gt;
     &lt;name value="1.8" /&gt;
     &lt;type value="JavaSDK" /&gt;
     &lt;version value="1.8" /&gt;
     &lt;homePath value="/usr/java" /&gt;
     &lt;roots&gt;
       &lt;annotationsPath&gt;
         &lt;root type="composite"&gt;
           &lt;root url="jar://$APPLICATION_HOME_DIR$/lib/jdkAnnotations.jar!/" type="simple" /&gt;
         &lt;/root&gt;
       &lt;/annotationsPath&gt;
       &lt;classPath&gt;
         &lt;root type="composite"&gt;
           &lt;root url="jar:///usr/java/jre/lib/charsets.jar!/" type="simple" /&gt;
           &lt;root url="jar:///usr/java/jre/lib/deploy.jar!/" type="simple" /&gt;
           &lt;root url="jar:///usr/java/jre/lib/ext/access-bridge-64.jar!/" type="simple" /&gt;
           &lt;root url="jar:///usr/java/jre/lib/ext/cldrdata.jar!/" type="simple" /&gt;
           &lt;root url="jar:///usr/java/jre/lib/ext/dnsns.jar!/" type="simple" /&gt;
           &lt;root url="jar:///usr/java/jre/lib/ext/jaccess.jar!/" type="simple" /&gt;
           &lt;root url="jar:///usr/java/jre/lib/ext/jfxrt.jar!/" type="simple" /&gt;
           &lt;root url="jar:///usr/java/jre/lib/ext/localedata.jar!/" type="simple" /&gt;
           &lt;root url="jar:///usr/java/jre/lib/ext/nashorn.jar!/" type="simple" /&gt;
           &lt;root url="jar:///usr/java/jre/lib/ext/sunec.jar!/" type="simple" /&gt;
           &lt;root url="jar:///usr/java/jre/lib/ext/sunjce_provider.jar!/" type="simple" /&gt;
           &lt;root url="jar:///usr/java/jre/lib/ext/sunmscapi.jar!/" type="simple" /&gt;
           &lt;root url="jar:///usr/java/jre/lib/ext/sunpkcs11.jar!/" type="simple" /&gt;
           &lt;root url="jar:///usr/java/jre/lib/ext/zipfs.jar!/" type="simple" /&gt;
           &lt;root url="jar:///usr/java/jre/lib/javaws.jar!/" type="simple" /&gt;
           &lt;root url="jar:///usr/java/jre/lib/jce.jar!/" type="simple" /&gt;
           &lt;root url="jar:///usr/java/jre/lib/jfr.jar!/" type="simple" /&gt;
           &lt;root url="jar:///usr/java/jre/lib/jfxswt.jar!/" type="simple" /&gt;
           &lt;root url="jar:///usr/java/jre/lib/jsse.jar!/" type="simple" /&gt;
           &lt;root url="jar:///usr/java/jre/lib/management-agent.jar!/" type="simple" /&gt;
           &lt;root url="jar:///usr/java/jre/lib/plugin.jar!/" type="simple" /&gt;
           &lt;root url="jar:///usr/java/jre/lib/resources.jar!/" type="simple" /&gt;
           &lt;root url="jar:///usr/java/jre/lib/rt.jar!/" type="simple" /&gt;
         &lt;/root&gt;
       &lt;/classPath&gt;
     &lt;/roots&gt;
     &lt;additional /&gt;
   &lt;/jdk&gt;
 &lt;/component&gt;
&lt;/application&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The image is <a href="https://hub.docker.com/r/inponomarev/intellij-idea-analyzer">available on Docker Hub</a>.</p>
</div>
<div class="paragraph">
<p>Before moving on, let’s check the IDEA analyzer’s launch in the container:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">docker run --rm -v &lt;path/to/your/project&gt;:/var/project inponomarev/intellij-idea-analyzer</code></pre>
</div>
</div>
<div class="paragraph">
<p>The analysis should work out successfully, and numerous .xml files with analyzer reports should appear in the <code>target/idea_inspections</code> subfolder.</p>
</div>
<div class="paragraph">
<p>Now there are no longer any doubts that the IDEA analyzer can be run in any CI environment, and we are moving on to the second step.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_2_display_and_analyze_the_report"><a class="anchor" href="#_step_2_display_and_analyze_the_report"></a>Step 2: Display and Analyze the Report</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Getting a report in the form of .xml files is half the battle; now we need to make it comprehensible to humans. Also, its results should be used in quality gates — the logic of determining whether an accepted change passes or does not pass the quality criteria.</p>
</div>
<div class="paragraph">
<p>Jenkins <a href="https://github.com/jenkinsci/warnings-ng-plugin">Warnings NG Plugin</a>, released in January 2019, will come in handy in doing that. Its emergence has made numerous individual plugins obsolete for working with static analysis results in Jenkins (CheckStyle, FindBugs, PMD, etc.).</p>
</div>
<div class="paragraph">
<p>The plugin contains two parts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Numerous analyzer message collectors (the <a href="https://github.com/jenkinsci/warnings-ng-plugin/blob/master/SUPPORTED-FORMATS.md">full list</a> includes every analyzer known to man, from AcuCobol to ZPT Lint);</p>
</li>
<li>
<p>A single report viewer for all of them.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The list of what Warnings NG can analyze includes warnings from the Java compiler and the Maven runtime logs: although they are constantly in sight, they are seldom expressly analyzed. IntelliJ IDEA inspections reports are also among the recognized formats.</p>
</div>
<div class="paragraph">
<p>Since the plugin is new, it works well with Jenkins Pipeline from the start. The build step that utilizes it will look like this (we just tell the plug-in which report format we are recognizing and which files should be scanned):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">stage ('Static analysis'){
    sh 'rm -rf target/idea_inspections'
    docker.image('inponomarev/intellij-idea-analyzer').inside {
       sh '/opt/idea/bin/inspect.sh $WORKSPACE $WORKSPACE/.idea/inspectionProfiles/Project_Default.xml $WORKSPACE/target/idea_inspections -v2'
    }
    recordIssues(
       tools: [ideaInspection(pattern: 'target/idea_inspections/*.xml')]
    )
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The report interface looks like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/idea-report.png" alt="idea report">
</div>
</div>
<div class="paragraph">
<p>Conveniently, this interface is universal for all recognized analyzers. It contains an interactive diagram of the distribution of analyzer warnings by category and a graph of the change dynamics in the number of warnings. The grid at the bottom of the page can be used to perform a quick search. The only thing that didn’t work correctly for IDEA inspections was the ability to browse the code directly in Jenkins (although for other reports, such as Checkstyle, this plugin can do it perfectly). This seems to be an IDEA report parser bug that’s yet to be fixed.</p>
</div>
<div class="paragraph">
<p>Among the features of Warnings NG is the fact that it allows its users to collect warnings from different sources in one report and program different types of quality gates, including the “ratchet” based on reference build. Some quality gates programming documentation is available <a href="https://github.com/jenkinsci/warnings-ng-plugin/blob/master/doc/Documentation.md#quality-gate-configuration">here</a> — unfortunately, it’s far from being complete, and one has to refer to the source code. On the other hand, the “ratchet” can be implemented independently for complete control over what is happening (see my <a href="ratcheting.html" class="xref page">previous post</a> on this topic).</p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<script id="site-script" src="../_/js/site.js" data-ui-root-path="../_"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
